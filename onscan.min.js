/*
 * onScan.js - scan-events for hardware barcodes scanners in javascript
 * Version: 1.5.2
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t()):e.onScan=t()}(this,function(){var e={attachTo:function(t,n){if(void 0!==t.scannerDetectionData)throw Error("onScan.js is already initialized for DOM element "+t);return n=this._mergeOptions({onScan:function(e,t){},onScanError:function(e){},onKeyProcess:function(e,t){},onKeyDetect:function(e,t){},onPaste:function(e,t){},keyCodeMapper:function(t){return e.decodeKeyEvent(t)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1},n),t.scannerDetectionData={options:n,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},!0===n.reactToPaste&&t.addEventListener("paste",this._handlePaste,n.captureEvents),!1!==n.scanButtonKeyCode&&t.addEventListener("keyup",this._handleKeyUp,n.captureEvents),(!0===n.reactToKeydown||!1!==n.scanButtonKeyCode)&&(t.addEventListener("input",this._handleInput,n.captureEvents),t.addEventListener("keydown",this._handleInput,n.captureEvents)),this},detachFrom:function(e){e.scannerDetectionData.options.reactToPaste&&e.removeEventListener("paste",this._handlePaste),!1!==e.scannerDetectionData.options.scanButtonKeyCode&&e.removeEventListener("keyup",this._handleKeyUp),e.removeEventListener("input",this._handleKeyDown),e.removeEventListener("keydown",this._handleKeyDown),e.scannerDetectionData=void 0},getOptions:function(e){return e.scannerDetectionData.options},setOptions:function(e,t){switch(e.scannerDetectionData.options.reactToPaste){case!0:!1===t.reactToPaste&&e.removeEventListener("paste",this._handlePaste);break;case!1:!0===t.reactToPaste&&e.addEventListener("paste",this._handlePaste)}return!1===e.scannerDetectionData.options.scanButtonKeyCode?!1!==t.scanButtonKeyCode&&e.addEventListener("keyup",this._handleKeyUp):!1===t.scanButtonKeyCode&&e.removeEventListener("keyup",this._handleKeyUp),e.scannerDetectionData.options=this._mergeOptions(e.scannerDetectionData.options,t),this._reinitialize(e),this},decodeKeyEvent:function(e){var t=this._getNormalizedKeyNum(e);switch(!0){case t>=48&&t<=90:case t>=106&&t<=111:if(void 0!==e.key&&""!==e.key)return e.key;var n=String.fromCharCode(t);switch(e.shiftKey){case!1:n=n.toLowerCase();break;case!0:n=n.toUpperCase()}return n;case t>=96&&t<=105:return 0+(t-96)}return""},simulate:function(e,t){return this._reinitialize(e),Array.isArray(t)?t.forEach(function(e){var t={};("object"==typeof e||"function"==typeof e)&&null!==e?t=e:t.keyCode=parseInt(e);var n=new KeyboardEvent("keydown",t);document.dispatchEvent(n)}):this._validateScanCode(e,t),this},_reinitialize:function(e){var t=e.scannerDetectionData.vars;t.firstCharTime=0,t.lastCharTime=0,t.accumulatedString=""},_isFocusOnIgnoredElement:function(e){var t=e.scannerDetectionData.options.ignoreIfFocusOn;if(!t)return!1;var n=document.activeElement;if(Array.isArray(t)){for(var a=0;a<t.length;a++)if(!0===n.matches(t[a]))return!0}else if(n.matches(t))return!0;return!1},_validateScanCode:function(t,n){var a,i=t.scannerDetectionData,r=i.options,o=i.options.singleScanQty,s=i.vars.firstCharTime,c=i.vars.lastCharTime,u={};switch(!0){case n.length<r.minLength:u={message:"Received code is shorter than minimal length"};break;case c-s>n.length*r.avgTimeByChar:u={message:"Received code was not entered in time"};break;default:return r.onScan.call(t,n,o),a=new CustomEvent("scan",{detail:{scanCode:n,qty:o}}),t.dispatchEvent(a),e._reinitialize(t),!0}return u.scanCode=n,u.scanDuration=c-s,u.avgTimeByChar=r.avgTimeByChar,u.minLength=r.minLength,r.onScanError.call(t,u),a=new CustomEvent("scanError",{detail:u}),t.dispatchEvent(a),e._reinitialize(t),!1},_mergeOptions:function(e,t){var n,a={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&(a[n]=e[n]);for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(a[n]=t[n]);return a},_getNormalizedKeyNum:function(e){return e.which||e.keyCode},_handleKeyDown:function(t){var n,a,i,r=this.scannerDetectionData.options,o=this.scannerDetectionData.vars,s=!1;if("input"===t.type)n=t.target.value.at(-1),a=t.target.value.toUpperCase().charCodeAt(t.target.value.length-1);else{if("Enter"!==t.key)return;a=e._getNormalizedKeyNum(t)}if(!(!1===r.onKeyDetect.call(this,a,t)||e._isFocusOnIgnoredElement(this))){if(!1!==r.scanButtonKeyCode&&a==r.scanButtonKeyCode){o.longPressed||(o.longPressTimer=setTimeout(r.onScanButtonLongPress,r.scanButtonLongPressTime,this),o.longPressed=!0);return}switch(!0){case o.firstCharTime&&-1!==r.suffixKeyCodes.indexOf(a):t.preventDefault(),t.stopImmediatePropagation(),s=!0;break;case!o.firstCharTime&&-1!==r.prefixKeyCodes.indexOf(a):t.preventDefault(),t.stopImmediatePropagation(),s=!1;break;default:if(null===(i=null!=n?n:r.keyCodeMapper.call(this,t)))return;o.accumulatedString+=i,r.preventDefault&&t.preventDefault(),r.stopPropagation&&t.stopImmediatePropagation(),s=!1}o.firstCharTime||(o.firstCharTime=Date.now()),o.lastCharTime=Date.now(),o.testTimer&&clearTimeout(o.testTimer),s?(e._validateScanCode(this,o.accumulatedString),o.testTimer=!1):o.testTimer=setTimeout(e._validateScanCode,r.timeBeforeScanTest,this,o.accumulatedString),r.onKeyProcess.call(this,i,t)}},_handlePaste:function(t){var n=this.scannerDetectionData.options,a=this.scannerDetectionData.vars,i=(event.clipboardData||window.clipboardData).getData("text");!e._isFocusOnIgnoredElement(this)&&(t.preventDefault(),n.stopPropagation&&t.stopImmediatePropagation(),n.onPaste.call(this,i,event),a.firstCharTime=0,a.lastCharTime=0,e._validateScanCode(this,i))},_handleKeyUp:function(t){!e._isFocusOnIgnoredElement(this)&&e._getNormalizedKeyNum(t)==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)},isScanInProgressFor:function(e){return e.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(e){return void 0!==e.scannerDetectionData}};return e});